<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‚≠ïTATETI DE LA SUERTE‚ùå</title>

  <!-- Lexend font -->
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* --- MISMAS VARIABLES DE TAMA√ëO (NO TOCAR) --- */
      --cell-size: clamp(56px, 7.2vw, 96px);
      --board-gap: clamp(6px, 1vw, 10px);
      --container-max-width: 760px;
      --container-vertical-margin: 48px;

      /* --- TEMA PLAYA (SOLO EST√âTICA) --- */
      --bg-sky-1: #22c1c3;   /* cielo/agua clara */
      --bg-sky-2: #1b8fd6;   /* turquesa */
      --bg-sea-1: #0f6aa6;   /* mar */
      --bg-sea-2: #0b3f7a;   /* profundo */

      --sand-1: #ffe2a6;
      --sand-2: #f7c97a;

      --accent-coral: #ff6b6b;
      --accent-sun:   #ffb703;

      --glass-1: rgba(255,255,255,0.07);
      --glass-2: rgba(255,255,255,0.03);
      --stroke:  rgba(255,255,255,0.05);
      --shadow:  rgba(2,6,23,0.32);

      --orange-bright: var(--accent-sun); /* reutilizamos el nombre para NO tocar JS */
    }

    /* Base */
    *{box-sizing:border-box;font-family:'Lexend', system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;}
    html,body{height:100%;margin:0;}

    body{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;

      /* Fondo playa (cielo -> mar) */
      background:
        linear-gradient(180deg,
          var(--bg-sky-1) 0%,
          var(--bg-sky-2) 28%,
          var(--bg-sea-1) 62%,
          var(--bg-sea-2) 100%
        );

      padding:16px;
      position:relative;
      overflow:hidden;
      -webkit-font-smoothing:antialiased;
    }

    /* Banda de arena sutil abajo (NO mueve nada, es pseudo-elemento) */
    body::before{
      content:"";
      position:fixed;
      left:0; right:0; bottom:0;
      height: 26vh;
      background:
        linear-gradient(180deg,
          rgba(255,255,255,0.00) 0%,
          rgba(255,255,255,0.00) 10%,
          rgba(255,226,166,0.38) 45%,
          rgba(247,201,122,0.55) 100%
        );
      pointer-events:none;
      z-index:0;
    }

    /* Ondas suaves (muy sutil) */
    body::after{
      content:"";
      position:fixed;
      left:0; right:0; bottom:0;
      height: 42vh;
      background:
        radial-gradient(60px 18px at 10% 85%, rgba(255,255,255,0.10), rgba(255,255,255,0.00) 70%),
        radial-gradient(70px 20px at 35% 90%, rgba(255,255,255,0.10), rgba(255,255,255,0.00) 70%),
        radial-gradient(68px 18px at 62% 86%, rgba(255,255,255,0.10), rgba(255,255,255,0.00) 70%),
        radial-gradient(76px 22px at 85% 92%, rgba(255,255,255,0.10), rgba(255,255,255,0.00) 70%);
      opacity: .55;
      pointer-events:none;
      z-index:0;
    }

    /* Background layers (very back) */
    #bgTridents,#bgEmojis{
      position:fixed;
      inset:0;
      z-index:0; /* behind everything */
      pointer-events:none;
    }
    .bg-item{ position:absolute; pointer-events:none; user-select:none; }

    /* App container (above background layers) */
    .container{
      width:100%;
      max-width:var(--container-max-width);
      max-height: calc(100vh - var(--container-vertical-margin));
      background: linear-gradient(180deg, var(--glass-1), var(--glass-2));
      border-radius:12px;
      padding:18px;
      box-shadow: 0 18px 40px var(--shadow), inset 0 1px 0 rgba(255,255,255,0.02);
      z-index: 10; /* above bg layers */
      display:flex;
      flex-direction:column;
      gap:10px;
      justify-content:space-between;
      align-items:center;
      border: 1px solid var(--stroke);

      /* leve ‚Äúglow‚Äù playa */
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }

    /* Header */
    .title{
      margin:0;
      font-size:1.25rem;
      color:#fff;
      font-weight:800;
      text-shadow:0 2px 10px rgba(0,0,0,0.22);
      letter-spacing:0.6px;
    }
    .subtitle{
      margin:4px 0 8px 0;
      color:rgba(255,255,255,0.92);
      font-size:0.88rem;
      font-weight:600;
    }

    /* Scoreboard */
    .scoreboard{ width:100%; display:flex; justify-content:space-between; gap:10px; margin-top:4px; }
    .score-item{
      flex:1;
      background: linear-gradient(180deg, rgba(255,255,255,0.035), rgba(0,0,0,0.02));
      padding:10px;
      border-radius:12px;
      text-align:center;
      min-width:0;
      border:1px solid rgba(255,255,255,0.045);
      box-shadow: inset 0 6px 18px rgba(0,0,0,0.06), 0 8px 20px rgba(0,0,0,0.10);
    }
    .score-item strong{ display:block; font-size:0.88rem; color: rgba(255,255,255,0.94); font-weight:800; }
    .score-item span{ display:block; margin-top:6px; font-weight:800; color:#fff; font-size:1.05rem; }
    .score-item small{ display:block; margin-top:4px; color: rgba(255,255,255,0.88); font-weight:700; }

    /* Board area */
    .board-area{ width:100%; display:flex; flex-direction:column; align-items:center; gap:10px; flex-shrink:1; overflow:visible; }
    .message{
      width:100%;
      padding:6px 8px;
      border-radius:8px;
      background:rgba(255,255,255,0.03);
      color:rgba(255,255,255,0.94);
      font-weight:600;
      text-align:center;
      font-size:0.95rem;
      border: 1px solid rgba(255,255,255,0.03);
    }

    .board{
      display:grid;
      grid-template-columns: repeat(3, var(--cell-size));
      grid-auto-rows: var(--cell-size);
      gap: var(--board-gap);
      padding:16px;
      border-radius:14px;

      /* tablero con ‚Äúagua‚Äù sutil */
      background:
        radial-gradient(120px 80px at 20% 20%, rgba(255,255,255,0.08), rgba(255,255,255,0.00) 70%),
        radial-gradient(140px 90px at 80% 35%, rgba(255,255,255,0.07), rgba(255,255,255,0.00) 70%),
        linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));

      box-shadow: 0 12px 30px rgba(0,0,0,0.18), inset 0 1px 0 rgba(255,255,255,0.02);
      justify-content:center;
      border: 1px solid rgba(255,255,255,0.04);
      z-index:12; /* above container base */
    }

    /* Cells */
    .cell{
      width: var(--cell-size);
      height: var(--cell-size);
      border-radius:12px;

      /* vidrio/turquesa */
      background:
        radial-gradient(70px 50px at 30% 25%, rgba(255,255,255,0.08), rgba(255,255,255,0.00) 70%),
        linear-gradient(180deg, rgba(255,255,255,0.035), rgba(0,0,0,0.04));

      border: 1px solid rgba(255,255,255,0.06);
      display:flex; align-items:center; justify-content:center;
      font-size: clamp(16px, 5.2vw, 40px);
      color:#fff;
      cursor:pointer;
      box-shadow: 0 12px 22px rgba(0,0,0,0.22), inset 0 4px 8px rgba(255,255,255,0.02);
      transition: transform .12s ease, box-shadow .12s ease;
      user-select:none;
    }
    .cell:hover{ transform: translateY(-4px); box-shadow: 0 18px 34px rgba(0,0,0,0.28); }
    .cell.disabled{ cursor:not-allowed; opacity:0.92; }
    .cell.win{
      outline:3px solid rgba(255,255,255,0.07);
      box-shadow: 0 18px 36px rgba(255,183,3,0.14);
    }

    /* Board logo fixed under the board (not overlapping cells) */
    .board-logo{
      margin-top:10px;
      max-width:160px;
      width:auto;
      height:auto;
      opacity:0.98;
      z-index:11;
      filter: drop-shadow(0 8px 18px rgba(0,0,0,0.18));
    }
    .board-logo.hidden{ display:none; }

    /* Intro overlay (centered, above app) */
    .intro-overlay{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;

      /* intro playa */
      background: linear-gradient(180deg, var(--bg-sky-1), var(--bg-sky-2));
      z-index: 2200;
    }
    .intro-overlay.hidden{ display:none; pointer-events:none; }
    .intro-card{
      width:min(520px, 44vw);
      padding:18px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:12px;
      position:relative;
      z-index:2210;
    }
    .intro-card img#introLogo{
      max-width: clamp(160px, 28vw, 420px);
      filter: drop-shadow(0 8px 18px rgba(0,0,0,0.22));
    }

    /* Loading bar */
    .loading-bar-outer{
      width:72%;
      max-width:560px;
      height:12px;
      background: rgba(0,0,0,0.12);
      border-radius:10px;
      overflow:hidden;
      margin-top:12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
      align-self:center;
      z-index:2215;
    }
    .loading-bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(255,255,255,0.92), var(--accent-sun), var(--accent-coral));
      border-radius:8px;
      transition: width .12s linear;
      z-index:2216;
    }
    .loading-text{
      margin-top:8px;
      color:#fff;
      font-weight:700;
      text-align:center;
      width:100%;
      align-self:center;
      z-index:2216;
    }

    /* Intro particles container */
    #introParticles{ position:absolute; inset:0; z-index:2195; pointer-events:none; }

    /* Background items styling (subtle) */
    .bg-item.trident{
      opacity: 0.08;
      filter: none;
      mix-blend-mode: normal;
      color: rgba(255,255,255,0.10);
      text-shadow: 0 2px 6px rgba(0,0,0,0.22);
    }
    .bg-item.emoji{
      opacity: 0.07;
      filter: none;
      text-shadow: 0 2px 6px rgba(0,0,0,0.18);
    }

    /* Banner (shown after intro completes) */
    .overlay{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: rgba(2,6,23,0.35);
      z-index: 2300;
    }
    .overlay.hidden{ display:none; pointer-events:none; }

    .overlay-card{
      background: linear-gradient(180deg, rgba(255,107,107,0.95), rgba(255,183,3,0.92));
      color:#fff;
      border-radius:12px;
      padding:20px;
      width:min(520px,92%);
      box-shadow: 0 22px 56px rgba(0,0,0,0.36);
      border: 1px solid rgba(255,255,255,0.08);
      text-align:center;
    }
    .opponent-text{ font-weight:900; letter-spacing:.5px; text-shadow: 0 2px 10px rgba(0,0,0,0.22); }
    .banner-start{
      min-width:160px;
      padding:10px 18px;
      font-weight:800;
      background:#fff;
      color: #0b3f7a;
      border-radius:10px;
      border:none;
      cursor:pointer;
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }
    .banner-start.disabled{ opacity:.6; cursor:not-allowed; }

    /* Modal centered and subtle background so details remain visible */
    .modal{
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2400;
      background: rgba(2, 6, 23, 0.16);
      transition: opacity .18s ease, visibility .18s ease;
    }
    .modal.hidden{ display: none; opacity: 0; visibility: hidden; pointer-events: none; }

    @keyframes modalEnter {
      from { opacity: 0; transform: translateY(-6px) scale(.98); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    .modal-content{
      border-radius:12px;
      box-shadow: 0 22px 52px rgba(0,0,0,0.36);
      border:1px solid rgba(255,255,255,0.08);
      padding:22px;

      /* modal ‚Äúmar profundo‚Äù */
      background: linear-gradient(180deg, rgba(11,63,122,0.96), rgba(15,106,166,0.94));
      color: #fff;

      min-width: 320px;
      max-width: 92%;
      width: min(420px, 88%);
      text-align: center;
      animation: modalEnter .22s ease both;
    }
    .modal-percent{ margin: 10px 0 14px; font-weight:900; font-size:1.6rem; line-height:1; }
    .modal-actions{ display:flex; justify-content:center; margin-top:8px; }
    .modal-actions .primary{ padding:8px 14px; }

    /* Buttons */
    .primary{
      background: linear-gradient(180deg, var(--accent-sun), var(--accent-coral));
      color:#083a66;
      font-weight:900;
      border-radius:10px;
      padding:10px 14px;
      border:none;
      box-shadow: 0 10px 28px rgba(0,0,0,0.18);
      cursor:pointer;
    }

    /* Date label */
    #currentDate{
      background: rgba(0,0,0,0.10) !important;
      border: 1px solid rgba(255,255,255,0.10);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }

    /* --- Animaciones (se mantienen nombres para NO tocar JS) --- */
    @keyframes tridentIntroFloat {
      0%   { transform: translate3d(0,0,0) rotate(-6deg); opacity: .12; }
      40%  { transform: translate3d(6px,-8px,0) rotate(3deg);  opacity: .18; }
      80%  { transform: translate3d(-6px,-12px,0) rotate(6deg); opacity: .14; }
      100% { transform: translate3d(0,0,0) rotate(-6deg); opacity: .12; }
    }

    /* Responsive adjustments (MISMO COMPORTAMIENTO) */
    @media (max-width:900px){
      :root{ --cell-size: clamp(56px, 14vw, 96px); }
      .container{ max-width:96%; max-height: calc(100vh - 40px); padding:12px; }
      .loading-bar-outer{ width:86%; }
      .modal{ background: rgba(2,6,23,0.14); }
      .modal-content{ width: min(560px, 92%); max-width: calc(100% - 48px); }
    }
    @media (max-width:480px){
      :root{ --cell-size: clamp(50px, 22vw, 92px); }
      .intro-card img#introLogo{ max-width:56vw; }
      .loading-bar-outer{ width:88%; height:10px; }
      .loading-text{ font-size:0.9rem; }
    }

    .overlay{
      background: linear-gradient(180deg, rgba(3, 28, 55, 0.38), rgba(3, 28, 55, 0.58)) !important;
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
    }

    /* Cartel: agua + arena, vidrio, y detalles (sin tocar padding/width) */
    .overlay-card{
      position: relative;
      overflow: hidden;

      /* Misma forma/espaciado (solo est√©tica) */
      border-radius: 12px;
      padding: 20px;
      width: min(520px, 92%);

      /* Playa */
      background:
        radial-gradient(140px 80px at 20% 25%, rgba(255,255,255,0.14), rgba(255,255,255,0) 70%),
        radial-gradient(160px 90px at 82% 35%, rgba(255,255,255,0.12), rgba(255,255,255,0) 72%),
        linear-gradient(180deg,
          rgba(34,193,195,0.92) 0%,
          rgba(27,143,214,0.90) 40%,
          rgba(255,226,166,0.92) 72%,
          rgba(247,201,122,0.94) 100%
        ) !important;

      border: 1px solid rgba(255,255,255,0.16) !important;
      box-shadow:
        0 22px 56px rgba(0,0,0,0.36),
        inset 0 1px 0 rgba(255,255,255,0.18),
        inset 0 -10px 30px rgba(0,0,0,0.10) !important;

      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }

    /* ‚ÄúEspuma/olas‚Äù arriba (decoraci√≥n, no ocupa espacio) */
    .overlay-card::before{
      content:"";
      position:absolute;
      left:-30px; right:-30px; top:-22px;
      height:88px;
      pointer-events:none;
      opacity:.55;
      background:
        radial-gradient(36px 14px at 10% 70%, rgba(255,255,255,0.55) 0 60%, rgba(255,255,255,0) 62%),
        radial-gradient(42px 16px at 26% 78%, rgba(255,255,255,0.50) 0 60%, rgba(255,255,255,0) 62%),
        radial-gradient(38px 14px at 42% 68%, rgba(255,255,255,0.52) 0 60%, rgba(255,255,255,0) 62%),
        radial-gradient(46px 18px at 60% 78%, rgba(255,255,255,0.48) 0 60%, rgba(255,255,255,0) 62%),
        radial-gradient(40px 15px at 76% 70%, rgba(255,255,255,0.52) 0 60%, rgba(255,255,255,0) 62%),
        radial-gradient(44px 17px at 92% 80%, rgba(255,255,255,0.48) 0 60%, rgba(255,255,255,0) 62%);
      filter: blur(.2px);
    }

    /* Burbujitas sutiles dentro del cartel (decoraci√≥n) */
    .overlay-card::after{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:.22;
      background:
        radial-gradient(10px 10px at 12% 30%, rgba(255,255,255,0.65), rgba(255,255,255,0) 70%),
        radial-gradient(8px 8px at 22% 62%, rgba(255,255,255,0.55), rgba(255,255,255,0) 70%),
        radial-gradient(12px 12px at 78% 34%, rgba(255,255,255,0.55), rgba(255,255,255,0) 70%),
        radial-gradient(9px 9px at 88% 66%, rgba(255,255,255,0.60), rgba(255,255,255,0) 70%);
      mix-blend-mode: soft-light;
    }

    /* Texto del cartel */
    .opponent-text{
      font-weight: 900 !important;
      letter-spacing: .6px !important;
      text-shadow: 0 2px 10px rgba(0,0,0,0.22) !important;
    }

    /* Bot√≥n ‚ÄúComenzar‚Äù m√°s playero, manteniendo tama√±o */
    .banner-start{
      min-width:160px;
      padding:10px 18px;

      background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.78)) !important;
      color: #0b3f7a !important;
      border: 1px solid rgba(255,255,255,0.35) !important;

      box-shadow:
        0 10px 22px rgba(0,0,0,0.14),
        inset 0 1px 0 rgba(255,255,255,0.35) !important;

      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
    }
    .banner-start:hover{
      transform: translateY(-2px);
      box-shadow:
        0 14px 30px rgba(0,0,0,0.18),
        inset 0 1px 0 rgba(255,255,255,0.35) !important;
    }
    .banner-start:active{ transform: translateY(0px); }
    .banner-start:focus{
      outline: none;
      box-shadow:
        0 0 0 3px rgba(255, 255, 255, 0.22),
        0 14px 30px rgba(0,0,0,0.18) !important;
    }

    /* Extras playa visibles en m√≥vil (sin mover nada) */
    @media (max-width: 520px){
      .overlay-card{
        border-radius: 14px !important;
      }

      /* Emojis playeros ‚Äúdecorativos‚Äù al lado del t√≠tulo SOLO en m√≥vil */
      .opponent-text{
        position: relative;
        display: inline-block;
        padding: 0 10px; /* no cambia layout real, solo aire para los emojis */
      }
      .opponent-text::before{
        content:"üèñÔ∏è";
        position:absolute;
        left:-18px;
        top:50%;
        transform: translateY(-50%) rotate(-8deg);
        font-size: 1.05rem;
        opacity:.95;
        filter: drop-shadow(0 2px 6px rgba(0,0,0,0.18));
        pointer-events:none;
      }
      .opponent-text::after{
        content:"üå¥";
        position:absolute;
        right:-18px;
        top:50%;
        transform: translateY(-50%) rotate(8deg);
        font-size: 1.05rem;
        opacity:.95;
        filter: drop-shadow(0 2px 6px rgba(0,0,0,0.18));
        pointer-events:none;
      }

      /* Un toque m√°s de burbujas en mobile */
      .overlay-card::after{
        opacity: .28 !important;
      }
    }   
  </style>
</head>

<body>
  <!-- Background layers (filled by JS) -->
  <div id="bgTridents" class="bg-layer" aria-hidden="true"></div>
  <div id="bgEmojis" class="bg-layer" aria-hidden="true"></div>

  <main class="container" id="app">
    <h1 class="title">‚≠ïTATETI DE LA SUERTE‚ùå</h1>
    <p class="subtitle">Veamos qu√© bono consegu√≠s hoy üèÉ‚Äç‚ôÇÔ∏èüí®</p>

    <section class="scoreboard">
      <div class="score-item">
        <strong>Tus victorias</strong>
        <span id="playerWins">0 / 3</span>
        <small id="playerBonusPercent">Bono: 0%</small>
      </div>
      <div class="score-item">
        <strong>Victorias NEXUS</strong>
        <span id="cpuWins">0 / 3</span>
        <small id="cpuBonusPercent">Bono: 0%</small>
      </div>
      <div class="score-item">
        <strong>Partidas restantes</strong>
        <span id="playsLeft">3</span>
      </div>
    </section>

    <section class="board-area">
      <div id="message" class="message">Comenz√° la serie tocando "Comenzar"</div>

      <div id="board" class="board" aria-label="Tablero de tatet√≠" role="grid">
        <button class="cell" data-index="0" aria-label="Casilla 0"></button>
        <button class="cell" data-index="1" aria-label="Casilla 1"></button>
        <button class="cell" data-index="2" aria-label="Casilla 2"></button>
        <button class="cell" data-index="3" aria-label="Casilla 3"></button>
        <button class="cell" data-index="4" aria-label="Casilla 4"></button>
        <button class="cell" data-index="5" aria-label="Casilla 5"></button>
        <button class="cell" data-index="6" aria-label="Casilla 6"></button>
        <button class="cell" data-index="7" aria-label="Casilla 7"></button>
        <button class="cell" data-index="8" aria-label="Casilla 8"></button>
      </div>

      <!-- Board logo: fixed under the board -->
      <img id="boardLogo" class="board-logo" src="images/logo.png" alt="Logo bajo el tablero" aria-hidden="true">
    </section>
  </main>

  <!-- INTRO overlay (shows logo + loading bar) -->
  <div id="introOverlay" class="intro-overlay" role="dialog" aria-modal="true" aria-label="Presentaci√≥n">
    <div class="intro-card">
      <img id="introLogo" src="images/logo2.png" alt="Logo presentaci√≥n" />
      <div class="loading-bar-outer" aria-hidden="true"><div id="loadingBar" class="loading-bar"></div></div>
      <div class="loading-text" id="loadingText" aria-hidden="true">Cargando el juego... 0%</div>
    </div>
  </div>

  <!-- Banner displayed AFTER intro completes; user must click to start -->
  <div id="opponentBanner" class="overlay hidden" role="dialog" aria-modal="true" aria-label="Cartel iniciar serie">
    <div class="overlay-card" role="region" aria-label="Oponente y comenzar">
      <div class="opponent-text">HOY JUGAR√ÅS CONTRA NEXUSü§ñ</div>
      <button id="startBtn" class="banner-start">Comenzar</button>
    </div>
  </div>

  <!-- Modal / Result panel (hidden until series is finished) -->
  <div id="resultModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content">
      <h2 id="modalTitle">Resultado final</h2>
      <p class="modal-label">EL BONO OBTENIDO ES:</p>
      <div id="modalPercent" class="modal-percent">0%</div>
      <p id="modalMessage" class="modal-subtext"></p>
      <p class="modal-instruction">Env√≠anos captura para reclamarlo</p>
      <div class="modal-actions">
        <button id="modalClose" class="primary">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    // script.js ‚Äî versi√≥n segura y corregida. (MISMO JS, solo embebido en el HTML)
    console.log('[tateti] script start');

    const cpuName = 'NEXUS';
    const WIN_COMBINATIONS = [
      [0,1,2],[3,4,5],[6,7,8],
      [0,3,6],[1,4,7],[2,5,8],
      [0,4,8],[2,4,6]
    ];
    const MAX_PLAYS = 3;
    const STORAGE_KEY = 'tatetiState_v2';
    const DATE_KEY = 'tatetiLastDate_v1';
    const INTRO_DURATION = 1600;

    let board = Array(9).fill(null);
    let playerSymbol = 'X';
    let cpuSymbol = 'O';
    let currentTurn = 'X';
    let running = false;
    let cpuThinking = false;
    let sessionStarted = false;
    let state = { playerWins:0, cpuWins:0, plays:0 };

    // DOM refs (populated on DOMContentLoaded)
    let boardEl, cells, messageEl;
    let introOverlay, introCard, introParticles;
    let loadingBar, loadingText;
    let opponentBanner, startBtn;
    let playerWinsEl, cpuWinsEl, playerBonusPercentEl, cpuBonusPercentEl, playsLeftEl;
    let resultModal, modalPercent, modalMessage, modalClose;
    let boardLogo, bgTridents, bgEmojis;

    function by(id){ return document.getElementById(id); }
    function dbg(...a){ console.debug('[tateti]', ...a); }
    function symbolToEmoji(s){ return s === 'X' ? '‚ùå' : (s === 'O' ? '‚≠ï' : s); }
    function message(txt){ if(messageEl) messageEl.textContent = txt; }

    /* ---------- Daily helpers ---------- */
    function getTodayKey(){
      return (new Date()).toISOString().slice(0,10); // YYYY-MM-DD
    }

    function finalBonusText(w) {
      if (!w || w <= 0) return { percent: 0, text: 'No obtuviste bono (0 victorias).' };
      if (w === 1) return { percent: 100, text: 'BONO DEL 100% üëÄ' };
      if (w === 2) return { percent: 150, text: 'BONO DEL 150%' };
      return          { percent: 200, text: 'BONO DEL 200% ü§Ø' };
    }

    /* ---------- Persistence ---------- */
    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw) state = JSON.parse(raw);
      }catch(e){
        state = {playerWins:0,cpuWins:0,plays:0};
      }
      updateScoreboardUI();
      updatePlaysUI();
      checkPlaysLimitUI();
    }
    function saveState(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){} }

    /* ---------- Daily reset ---------- */
    function checkAndResetDaily(){
      const today = getTodayKey();
      const last = localStorage.getItem(DATE_KEY);
      if(last !== today){
        state.plays = 0;
        state.playerWins = 0;
        state.cpuWins = 0;
        saveState();
        localStorage.setItem(DATE_KEY, today);
        dbg('Applied daily reset for', today);
      }
      updateScoreboardUI();
      updatePlaysUI();
      checkPlaysLimitUI();
    }
    function scheduleMidnightReset(){
      const now = new Date();
      const next = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 0, 0, 2);
      const ms = next - now;
      if(ms <= 0){
        setTimeout(()=>{ checkAndResetDaily(); scheduleMidnightReset(); }, 60*1000);
        return;
      }
      setTimeout(()=>{ checkAndResetDaily(); updateDateUI(); scheduleMidnightReset(); }, ms);
    }

    /* ---------- Background helpers ---------- */
    function createBgLayer(id){
      let el = by(id);
      if(!el){
        el = document.createElement('div');
        el.id = id;
        el.style.position = 'fixed';
        el.style.inset = '0';
        el.style.zIndex = '0';
        el.style.pointerEvents = 'none';
        document.body.appendChild(el);
      }
      return el;
    }

    function populateBackground(){
      bgTridents = createBgLayer('bgTridents');
      bgEmojis  = createBgLayer('bgEmojis');

      if(bgEmojis){
        bgEmojis.style.setProperty('display','block','important');
        bgEmojis.style.pointerEvents = 'none';
        bgEmojis.style.zIndex = '0';
      }

      if(bgTridents) bgTridents.innerHTML = '';
      if(bgEmojis)  bgEmojis.innerHTML = '';

      const W = Math.max(window.innerWidth, 800);
      const H = Math.max(window.innerHeight, 600);
      const mobile = window.innerWidth <= 480;
      const densityFactor = mobile ? 0.35 : 1;

      function place(container, count, factory, minDist = 60){
        if(!container) return;
        const placed = [];
        const padding = mobile ? 12 : 24;
        const N = Math.max(3, Math.round(count * densityFactor));
        for(let i=0;i<N;i++){
          let attempts = 0, x, y, ok;
          do {
            x = Math.random() * (W - padding*2) + padding;
            y = Math.random() * (H - padding*2) + padding;
            ok = true;
            for(const p of placed) if(Math.hypot(p.x-x,p.y-y) < minDist){ ok = false; break; }
            attempts++;
          } while(!ok && attempts < 40);
          placed.push({x,y});
          const node = factory();
          if(!node) continue;
          node.style.position = node.style.position || 'absolute';
          node.style.left = node.style.left || `${x}px`;
          node.style.top  = node.style.top  || `${y}px`;
          const dur = mobile ? (2.6 + Math.random()*2).toFixed(2) + 's' : (4 + Math.random()*4).toFixed(2) + 's';
          node.style.animationName = node.style.animationName || 'tridentIntroFloat';
          node.style.animationDuration = dur;
          node.style.animationDelay = (Math.random()*1.2).toFixed(2) + 's';
          node.style.animationTimingFunction = 'ease-in-out';
          node.style.animationIterationCount = 'infinite';
          node.style.animationDirection = 'alternate';
          container.appendChild(node);
        }
      }

      const trCount = Math.round(Math.max(6, Math.min(30, (W*H)/250000)));
      place(bgTridents, trCount, () => {
        const el = document.createElement('div');
        el.className = 'bg-item trident';
        el.textContent = 'üî±';
        el.style.fontSize = `${10 + Math.floor(Math.random()*20)}px`;
        el.style.opacity = (mobile ? (0.04 + Math.random()*0.12) : (0.03 + Math.random()*0.08)).toString();
        el.style.transform = `rotate(${(-12 + Math.random()*24).toFixed(1)}deg)`;
        if(mobile){
          el.style.setProperty('filter','none','important');
          el.style.setProperty('color','rgba(255,255,255,0.95)','important');
        }
        return el;
      }, 50);

      const emojis = ['‚≠ï','‚ùå','üéÅ','‚ú®'];
      const emCount = Math.round(Math.max(6, Math.min(18, (W*H)/300000)));
      place(bgEmojis, emCount, () => {
        const elIsMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.innerWidth <= 480;
        const ch = emojis[Math.floor(Math.random()*emojis.length)];
        if(elIsMobile){
          const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><g fill='none' fill-rule='evenodd'><rect x='2' y='6' width='20' height='12' rx='3' fill='%23FFD9B3' stroke='%23F17321' stroke-width='0.8'/><path d='M6 8c1.2-2 4-2.5 6-1.6C14 6.5 16.3 6 18 8' stroke='%23F17321' stroke-width='0.8' fill='none' stroke-linecap='round'/></g></svg>`;
          const img = document.createElement('img');
          img.className = 'bg-item emoji';
          img.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
          img.style.width = `${10 + Math.floor(Math.random()*14)}px`;
          img.style.height = 'auto';
          img.style.opacity = (0.10 + Math.random()*0.16).toFixed(2);
          img.style.transform = `rotate(${(-25 + Math.random()*50).toFixed(1)}deg)`;
          img.style.pointerEvents = 'none';
          img.style.userSelect = 'none';
          img.style.setProperty('filter','none','important');
          img.style.setProperty('z-index','0','important');
          return img;
        } else {
          const el = document.createElement('div');
          el.className = 'bg-item emoji';
          el.textContent = ch;
          el.style.fontSize = `${12 + Math.floor(Math.random()*26)}px`;
          el.style.opacity = (0.02 + Math.random()*0.05).toString();
          el.style.transform = `rotate(${(-25 + Math.random()*50).toFixed(1)}deg)`;
          el.style.pointerEvents = 'none';
          el.style.userSelect = 'none';
          el.style.setProperty('font-family', '"Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Twemoji Mozilla", sans-serif', 'important');
          el.style.setProperty('color', 'rgba(255,255,255,0.98)', 'important');
          el.style.setProperty('filter', 'none', 'important');
          return el;
        }
      }, 40);
    }

    /* ---------- Intro particles ---------- */
    function ensureIntroParticlesContainer(){
      introOverlay = introOverlay || by('introOverlay');
      if(!introOverlay) return false;
      introParticles = introParticles || by('introParticles');
      if(!introParticles){
        introParticles = document.createElement('div');
        introParticles.id = 'introParticles';
        introParticles.style.position = 'absolute';
        introParticles.style.inset = '0';
        introParticles.style.zIndex = '2195';
        introParticles.style.pointerEvents = 'none';
        introOverlay.appendChild(introParticles);
      }
      return true;
    }
    function populateIntroParticles(){
      if(!ensureIntroParticlesContainer()) return;
      introParticles.innerHTML = '';
      const rect = introOverlay.getBoundingClientRect();
      const W = Math.max(rect.width, window.innerWidth);
      const H = Math.max(rect.height, window.innerHeight);
      const count = Math.round(Math.max(8, Math.min(18, (W*H)/280000)));
      for(let i=0;i<count;i++){
        const node = document.createElement('div');
        node.className = 'bg-item trident';
        node.textContent = 'üî±';
        node.style.position = 'absolute';
        node.style.left = `${Math.random() * Math.max(200, W)}px`;
        node.style.top  = `${Math.random() * Math.max(200, H)}px`;
        const r = Math.random();
        node.style.fontSize = (r < 0.45 ? 12 : (r < 0.86 ? 16 : 22)) + 'px';
        node.style.setProperty('color','rgba(255,255,255,0.98)','important');
        node.style.setProperty('opacity', (0.22 + Math.random()*0.12).toFixed(2), 'important');
        node.style.setProperty('filter','none','important');
        node.style.setProperty('text-shadow','0 2px 6px rgba(0,0,0,0.28)','important');
        node.style.animationName = 'tridentIntroFloat';
        node.style.animationDuration = (3 + Math.random()*6).toFixed(2) + 's';
        node.style.animationDelay = (Math.random()*1.6).toFixed(2) + 's';
        node.style.animationTimingFunction = 'ease-in-out';
        node.style.animationIterationCount = 'infinite';
        node.style.animationDirection = 'alternate';
        introParticles.appendChild(node);
      }
      requestAnimationFrame(()=> { if(introParticles) introParticles.classList.add('visible'); });
    }

    /* ---------- Date UI ---------- */
    function updateDateUI(){
      let el = by('currentDate');
      if(!el){
        el = document.createElement('div');
        el.id = 'currentDate';
        el.style.position = 'fixed';
        el.style.left = '50%';
        el.style.transform = 'translateX(-50%)';
        el.style.bottom = '8px';
        el.style.padding = '6px 10px';
        el.style.borderRadius = '8px';
        el.style.background = 'rgba(0,0,0,0.08)';
        el.style.color = '#fff';
        el.style.fontWeight = '700';
        el.style.fontSize = '0.95rem';
        el.style.zIndex = '2350';
        el.style.pointerEvents = 'none';
        document.body.appendChild(el);
      }
      const now = new Date();
      const opts = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
      el.textContent = now.toLocaleDateString(undefined, opts);
    }

    /* ---------- Loading animation ---------- */
    function animateLoading(duration){
      return new Promise(resolve=>{
        if(!loadingBar || !loadingText) {
          setTimeout(resolve, duration);
          return;
        }
        const start = performance.now();
        function step(now){
          const pct = Math.min(1, (now - start) / duration);
          const p = Math.round(pct * 100);
          loadingBar.style.width = `${p}%`;
          loadingText.textContent = `Cargando el juego... ${p}%`;
          if(pct < 1) requestAnimationFrame(step);
          else {
            loadingText.textContent = 'Listo';
            setTimeout(resolve, 240);
          }
        }
        requestAnimationFrame(step);
      });
    }

    /* ---------- Banner control ---------- */
    function attachStartListener(){
      startBtn = startBtn || by('startBtn');
      if(!startBtn) return;
      startBtn.type = 'button';
      if(startBtn._h) startBtn.removeEventListener('click', startBtn._h);
      startBtn._h = ()=>{ hideBanner(); startGame(); };
      startBtn.addEventListener('click', startBtn._h);
      startBtn.disabled = false;
      startBtn.classList.remove('disabled');
    }
    function showBanner(){ const b = by('opponentBanner'); if(!b) return; b.classList.remove('hidden'); b.setAttribute('aria-hidden','false'); }
    function hideBanner(){ const b = by('opponentBanner'); if(!b) return; b.classList.add('hidden'); b.setAttribute('aria-hidden','true'); }

    /* ---------- Flow ---------- */
    async function showIntroThenProceed(){
      introOverlay = introOverlay || by('introOverlay');
      if(!introOverlay){ attachStartListener(); showBanner(); return; }
      introOverlay.classList.remove('hidden');
      introOverlay.setAttribute('aria-hidden','false');
      try{ populateBackground(); }catch(e){ dbg('populateBackground err', e); }
      try{ populateIntroParticles(); }catch(e){ dbg('populateIntroParticles err', e); }
      try { await animateLoading(INTRO_DURATION); } catch(e){ console.error('animateLoading', e); }
      if(introParticles){
        introParticles.classList.remove('visible');
        setTimeout(()=>{ if(introParticles) introParticles.innerHTML = ''; }, 300);
      }
      introOverlay.classList.add('hidden');
      introOverlay.setAttribute('aria-hidden','true');
      attachStartListener();
      showBanner();
      dbg('Intro finished; banner shown');
    }

    /* ---------- Init ---------- */
    document.addEventListener('DOMContentLoaded', async ()=>{
      try{
        console.log('[tateti] DOMContentLoaded start');
        // refs
        boardEl = by('board'); cells = Array.from(document.querySelectorAll('.cell')); messageEl = by('message');
        introOverlay = by('introOverlay'); introCard = introOverlay ? introOverlay.querySelector('.intro-card') : null;
        introParticles = by('introParticles');
        opponentBanner = by('opponentBanner'); startBtn = by('startBtn');
        playerWinsEl = by('playerWins'); cpuWinsEl = by('cpuWins'); playerBonusPercentEl = by('playerBonusPercent'); cpuBonusPercentEl = by('cpuBonusPercent'); playsLeftEl = by('playsLeft');
        resultModal = by('resultModal'); modalPercent = by('modalPercent'); modalMessage = by('modalMessage'); modalClose = by('modalClose');
        boardLogo = by('boardLogo');
        loadingBar = by('loadingBar'); loadingText = by('loadingText');

        if(!boardEl || !cells.length || !messageEl){
          console.error('[tateti] FATAL: elementos faltantes', { boardEl, cellsLength: cells.length, messageEl });
          return;
        }

        if(modalClose) modalClose.addEventListener('click', ()=>{ if(resultModal) resultModal.classList.add('hidden'); });
        cells.forEach(c => c.addEventListener('click', onCellClick));

        document.addEventListener('keydown', (e)=>{
          if(e.key==='Enter' && !sessionStarted && opponentBanner && !opponentBanner.classList.contains('hidden')){
            hideBanner(); startGame();
          }
        });

        // load state then check daily reset
        loadState();
        checkAndResetDaily();
        updateDateUI();
        scheduleMidnightReset();

        setActiveChoice(); resetBoardUI();

        if(introOverlay) introOverlay.classList.add('hidden');
        if(opponentBanner) opponentBanner.classList.add('hidden');
        if(resultModal) resultModal.classList.add('hidden');

        try{ populateBackground(); }catch(e){ dbg('populateBackground error', e); }
        try{ populateIntroParticles(); }catch(e){ dbg('populateIntroParticles error', e); }

        window.addEventListener('resize', ()=>{ try{ populateBackground(); }catch(e){} });

        if(state.plays >= MAX_PLAYS){
          const info = finalBonusText(state.playerWins);
          if(modalPercent){ modalPercent.textContent = ''; modalPercent.style.display = 'none'; }
          if(modalMessage){
            modalMessage.innerHTML = `
              <div style="font-size:1.18rem; font-weight:800; line-height:1.2; text-align:center;">
                ${info.text}
              </div>
              <div style="margin-top:10px; font-size:0.92rem; font-weight:700; text-align:center;">
              </div>
            `;
          }
          if(resultModal) resultModal.classList.remove('hidden');
        } else {
          await showIntroThenProceed();
        }

        attachStartListener();
        dbg('Init complete');
      }catch(err){
        console.error('[tateti] error in DOMContentLoaded handler', err);
      }
    });

    /* ---------- Game logic (unchanged) ---------- */
    function showBoardLogo(){ if(!boardLogo) return; boardLogo.classList.remove('hidden'); boardLogo.style.display='block'; }
    function hideBoardLogo(){ if(!boardLogo) return; boardLogo.classList.add('hidden'); boardLogo.style.display='none'; }

    function updateScoreboardUI(){
      if(playerWinsEl) playerWinsEl.textContent = `${state.playerWins} / ${MAX_PLAYS}`;
      if(cpuWinsEl) cpuWinsEl.textContent = `${state.cpuWins} / ${MAX_PLAYS}`;
      if(playerBonusPercentEl) playerBonusPercentEl.textContent = `Bono: ${bonusPercent(state.playerWins)}%`;
      if(cpuBonusPercentEl) cpuBonusPercentEl.textContent = `Bono: ${bonusPercent(state.cpuWins)}%`;
    }
    function updatePlaysUI(){ if(playsLeftEl) playsLeftEl.textContent = Math.max(0, MAX_PLAYS - state.plays); }
    function bonusPercent(w){ if(w<=0) return 0; if(w===1) return 100; if(w===2) return 150; return 200; }

    function checkPlaysLimitUI(){
      if(!startBtn) return;
      if(state.plays >= MAX_PLAYS){
        startBtn.disabled=true;
        startBtn.classList.add('disabled');
        message('Has alcanzado el m√°ximo de 3 partidas.');
        hideBanner();
        if(introOverlay) introOverlay.classList.add('hidden');
        hideBoardLogo();
      } else {
        if(sessionStarted){
          startBtn.disabled=true;
          startBtn.classList.add('disabled');
        } else {
          startBtn.disabled=false;
          startBtn.classList.remove('disabled');
        }
      }
    }
    function setActiveChoice(){ /* no-op; X fixed */ }
    function resetBoardUI(){ cells.forEach(c=>{ c.innerHTML=''; c.classList.remove('disabled','win'); c.disabled=false; }); }

    function startGame(){
      if(state.plays >= MAX_PLAYS){
        message('No puedes comenzar: alcanzaste el l√≠mite.');
        return;
      }
      sessionStarted=true;
      checkPlaysLimitUI();
      resetBoardUI();
      board=Array(9).fill(null);
      currentTurn=playerSymbol;
      running=true;
      cpuThinking=false;
      message(`Juego iniciado ‚Äî T√∫: ${symbolToEmoji(playerSymbol)}  |  ${cpuName}: ${symbolToEmoji(cpuSymbol)}`);
      showBoardLogo();
    }

    function onCellClick(e){
      if(!running || cpuThinking) return;
      const idx = Number(e.currentTarget.dataset.index);
      if(Number.isNaN(idx)) return;
      if(board[idx]) return;
      if(currentTurn !== playerSymbol) return;
      makeMove(idx, playerSymbol);
      afterMove();
      setTimeout(()=>{ if(running && !cpuThinking && currentTurn===cpuSymbol) doCpuTurn(); }, 420);
    }
    function makeMove(i,s){
      board[i]=s;
      const c=cells[i];
      if(c){
        c.innerHTML=`<span>${symbolToEmoji(s)}</span>`;
        c.classList.add('disabled');
      }
    }
    function afterMove(){
      const w = checkWinner(board);
      if(w){ handleEnd(w); return; }
      currentTurn = currentTurn==='X'?'O':'X';
      if(running && currentTurn===cpuSymbol) doCpuTurn();
    }
    function doCpuTurn(){
      cpuThinking=true;
      message(`${cpuName} est√° pensando...`);
      setTimeout(()=>{
        const m = cpuVeryEasyMove();
        if(m!==undefined && m!==null) makeMove(m,cpuSymbol);
        cpuThinking=false;
        afterMove();
      }, 420);
    }
    function cpuVeryEasyMove(){
      const blockProb=0.30, heurProb=0.05;
      const block=findWinningMove(board, playerSymbol);
      if(block!==null && Math.random()<blockProb) return block;
      if(Math.random()<heurProb){
        if(board[4]===null) return 4;
        const corners=[0,2,6,8].filter(i=>board[i]===null);
        if(corners.length) return corners[Math.floor(Math.random()*corners.length)];
        const sides=[1,3,5,7].filter(i=>board[i]===null);
        if(sides.length) return sides[Math.floor(Math.random()*sides.length)];
      }
      return cpuRandomMove();
    }
    function cpuRandomMove(){
      const avail = availableMoves(board);
      if(avail.length===0) return null;
      return avail[Math.floor(Math.random()*avail.length)];
    }
    function availableMoves(b){ return b.map((v,i)=> v===null?i:null).filter(v=>v!==null); }
    function findWinningMove(b,sym){
      for(const i of availableMoves(b)){
        b[i]=sym;
        const w=checkWinner(b);
        b[i]=null;
        if(w===sym) return i;
      }
      return null;
    }
    function checkWinner(b){
      for(const [a,b1,c] of WIN_COMBINATIONS){
        if(b[a] && b[a]===b[b1] && b[a]===b[c]) return b[a];
      }
      if(b.every(v=>v!==null)) return 'D';
      return null;
    }

    function handleEnd(winner){
      running=false;
      if(state.plays < MAX_PLAYS) state.plays += 1;

      if(winner === 'D'){
        message('Empate üôÉ ‚Äî no hay bono adicional');
      } else {
        if(winner === playerSymbol){
          state.playerWins = Math.min(MAX_PLAYS, state.playerWins + 1);
          message('¬°Ganaste esta partida! üéâ');
        } else {
          state.cpuWins = Math.min(MAX_PLAYS, state.cpuWins + 1);
          message(`${cpuName} gana esta partida üò¢`);
        }
        for(const [a,b,c] of WIN_COMBINATIONS){
          if(board[a] && board[a] === board[b] && board[a] === board[c]){
            if(cells[a]) cells[a].classList.add('win');
            if(cells[b]) cells[b].classList.add('win');
            if(cells[c]) cells[c].classList.add('win');
            break;
          }
        }
      }

      cells.forEach(c=>c.classList.add('disabled'));

      saveState();
      updateScoreboardUI();
      updatePlaysUI();
      checkPlaysLimitUI();

      if(state.plays < MAX_PLAYS){
        setTimeout(()=>{
          board = Array(9).fill(null);
          resetBoardUI();
          currentTurn = playerSymbol;
          running = true;
          message(`Siguiente partida iniciada ‚Äî Partida ${state.plays + 1} de ${MAX_PLAYS}`);
          showBoardLogo();
        }, 900);
      } else {
        setTimeout(()=>{
          try{
            const info = finalBonusText(state.playerWins);
            if(modalPercent){
              modalPercent.textContent = '';
              modalPercent.style.display = 'none';
            }
            if(modalMessage){
              modalMessage.innerHTML = `
                <div style="font-size:1.18rem; font-weight:800; line-height:1.2; text-align:center;">
                  ${info.text}
                </div>
                <div style="margin-top:10px; font-size:0.92rem; font-weight:700; text-align:center;">
                </div>
              `;
            }
            if(resultModal) resultModal.classList.remove('hidden');
            hideBoardLogo();
          }catch(err){
            console.error('[tateti] error showing final modal', err);
          }
        }, 700);
      }
    }
  </script>
</body>
</html>
